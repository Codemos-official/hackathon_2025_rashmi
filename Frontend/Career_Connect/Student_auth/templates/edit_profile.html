<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Profile</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 20px;
        }
        .profile-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }
        .profile-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid #007bff;
            padding-bottom: 15px;
        }
        .profile-pic-section {
            text-align: center;
            margin-bottom: 30px;
        }
        .profile-pic {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            object-fit: cover;
            border: 5px solid #007bff;
        }
        .form-label {
            font-weight: 600;
            color: #495057;
        }
        .btn-custom {
            padding: 10px 30px;
            font-weight: 600;
        }
        .alert {
            border-radius: 8px;
        }
        /* Add fade-in animation for alerts */
        .fade-in {
            animation: fadeIn 0.5s;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="profile-container">
            <div class="profile-header">
                <h2>Edit Your Profile</h2>
                <p class="text-muted">Update your personal information below</p>
            </div>

            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show fade-in" role="alert">
                            <i class="fas fa-{{ 'exclamation-circle' if category == 'error' else 'check-circle' }} me-2"></i>
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <form method="POST" action="{{ url_for('edit_profile') }}" enctype="multipart/form-data">
                <!-- Profile Picture Section -->
                <div class="profile-pic-section">
                    {% if profile_pic %}
                        <!-- FIXED: Use correct URL for uploaded files -->
                        <img src="{{ url_for('uploaded_file', filename=profile_pic) }}" 
                             class="profile-pic mb-3" 
                             alt="Profile Picture"
                             onerror="this.onerror=null; this.src='https://via.placeholder.com/150'">
                    {% else %}
                        <div class="profile-pic-placeholder mb-3">
                            <img src="https://via.placeholder.com/150" class="profile-pic" alt="Default Profile">
                        </div>
                    {% endif %}
                    <div class="mb-3">
                        <label for="profile_pic" class="form-label">Change Profile Picture</label>
                        <input type="file" class="form-control" id="profile_pic" name="profile_pic" accept="image/*">
                        <div class="form-text">Maximum file size: 5MB. Supported formats: JPG, PNG, GIF, WebP</div>
                    </div>
                </div>

                <!-- Personal Information -->
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="name" class="form-label">Full Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="name" name="name" 
                               value="{{ name }}" required maxlength="100">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="email" class="form-label">Email Address</label>
                        <input type="email" class="form-control" id="email" 
                               value="{{ email }}" readonly>
                        <div class="form-text">Email cannot be changed</div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="education" class="form-label">Education Level <span class="text-danger">*</span></label>
                        <select class="form-select" id="education" name="education" required>
                            <option value="">Select Education Level</option>
                            <option value="High School" {% if education == 'High School' %}selected{% endif %}>High School</option>
                            <option value="Undergraduate" {% if education == 'Undergraduate' %}selected{% endif %}>Undergraduate (Bachelor's)</option>
                            <option value="Post Graduate" {% if education == 'Post Graduate' %}selected{% endif %}>Post Graduate (Master's)</option>
                            <option value="PhD" {% if education == 'PhD' %}selected{% endif %}>PhD/Doctorate</option>
                            <option value="Diploma" {% if education == 'Diploma' %}selected{% endif %}>Diploma</option>
                            <option value="Certificate" {% if education == 'Certificate' %}selected{% endif %}>Certificate Course</option>
                            <option value="Other" {% if education == 'Other' %}selected{% endif %}>Other</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="role" class="form-label">Current Role <span class="text-danger">*</span></label>
                        <select class="form-select" id="role" name="role" required>
                            <option value="">Select Your Role</option>
                            <option value="Student" {% if role == 'Student' %}selected{% endif %}>Student</option>
                            <option value="Working Professional" {% if role == 'Working Professional' %}selected{% endif %}>Working Professional</option>
                            <option value="Job Seeker" {% if role == 'Job Seeker' %}selected{% endif %}>Job Seeker</option>
                            <option value="Researcher" {% if role == 'Researcher' %}selected{% endif %}>Researcher</option>
                            <option value="Academic" {% if role == 'Academic' %}selected{% endif %}>Academic/Professor</option>
                            <option value="Intern" {% if role == 'Intern' %}selected{% endif %}>Intern</option>
                            <option value="Freelancer" {% if role == 'Freelancer' %}selected{% endif %}>Freelancer</option>
                            <option value="Entrepreneur" {% if role == 'Entrepreneur' %}selected{% endif %}>Entrepreneur</option>
                            <option value="Other" {% if role == 'Other' %}selected{% endif %}>Other</option>
                        </select>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="location" class="form-label">Location</label>
                    <input type="text" class="form-control" id="location" name="location" 
                           value="{{ location }}" placeholder="e.g., New York, USA or Remote" maxlength="100">
                </div>

                <!-- Skills Section -->
                <div class="mb-3">
                    <label for="skills" class="form-label">Skills & Expertise</label>
                    <textarea class="form-control" id="skills" name="skills" 
                              rows="3" placeholder="Enter your skills, technologies, tools (comma-separated)">{{ skills }}</textarea>
                    <div class="form-text">Example: Python, Flask, SQL, JavaScript, HTML/CSS, React, Django, Machine Learning</div>
                </div>

                <!-- Experience Section -->
                <div class="mb-3">
                    <label for="experience" class="form-label">Experience & Background</label>
                    <textarea class="form-control" id="experience" name="experience" 
                              rows="4" placeholder="Describe your experience, projects, achievements, or background...">{{ experience }}</textarea>
                    <div class="form-text">Share your professional experience, projects you've worked on, or relevant background information.</div>
                </div>

                <!-- Progress Section (Optional) -->
                <div class="mb-4">
                    <label class="form-label">Profile Completion</label>
                    <div class="progress">
                        <div class="progress-bar bg-success" role="progressbar" 
                             style="width: {{ session.get('progress', 0) }}%;" 
                             aria-valuenow="{{ session.get('progress', 0) }}" 
                             aria-valuemin="0" aria-valuemax="100">
                            {{ session.get('progress', 0) }}%
                        </div>
                    </div>
                    <div class="form-text">Complete your profile to increase your progress</div>
                </div>

                <!-- Buttons -->
                <div class="d-flex justify-content-between mt-4">
                    <a href="{{ url_for('dashboard') }}" class="btn btn-secondary btn-custom">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                    <div>
                        <button type="reset" class="btn btn-outline-secondary btn-custom me-2">
                            <i class="fas fa-redo"></i> Reset Form
                        </button>
                        <button type="submit" class="btn btn-primary btn-custom">
                            <i class="fas fa-save"></i> Save Changes
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Preview profile picture before upload
        document.getElementById('profile_pic')?.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                // Validate file type
                const validTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
                if (!validTypes.includes(file.type)) {
                    alert('Please select a valid image file (JPG, PNG, GIF, or WebP)');
                    this.value = '';
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = document.querySelector('.profile-pic') || document.querySelector('.profile-pic-placeholder img');
                    if (img) {
                        img.src = e.target.result;
                        img.classList.add('fade-in');
                    }
                }
                reader.readAsDataURL(file);
            }
        });

        // Form validation with better feedback
        document.querySelector('form').addEventListener('submit', function(e) {
            const name = document.getElementById('name').value.trim();
            const education = document.getElementById('education').value;
            const role = document.getElementById('role').value;
            
            // Clear previous error highlights
            document.querySelectorAll('.is-invalid').forEach(el => {
                el.classList.remove('is-invalid');
            });
            
            let hasError = false;
            
            if (!name) {
                document.getElementById('name').classList.add('is-invalid');
                hasError = true;
            }
            
            if (!education) {
                document.getElementById('education').classList.add('is-invalid');
                hasError = true;
            }
            
            if (!role) {
                document.getElementById('role').classList.add('is-invalid');
                hasError = true;
            }
            
            // Validate file size if uploaded
            const fileInput = document.getElementById('profile_pic');
            if (fileInput && fileInput.files[0]) {
                const fileSize = fileInput.files[0].size / 1024 / 1024; // in MB
                if (fileSize > 5) {
                    alert('File size must be less than 5MB. Your file is ' + fileSize.toFixed(2) + 'MB');
                    hasError = true;
                }
            }
            
            if (hasError) {
                e.preventDefault();
                
                // Scroll to first error
                const firstError = document.querySelector('.is-invalid');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError.focus();
                }
                
                return false;
            }
            
            // Show loading state
            const submitBtn = document.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            submitBtn.disabled = true;
            
            return true;
        });

        // Auto-dismiss alerts after 5 seconds
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                const alerts = document.querySelectorAll('.alert');
                alerts.forEach(alert => {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                });
            }, 5000);
        });

        // Character counters
        const skillsTextarea = document.getElementById('skills');
        const experienceTextarea = document.getElementById('experience');
        
        function updateCounter(textarea, maxLength) {
            const counter = textarea.nextElementSibling?.querySelector('.char-counter');
            if (counter) {
                const currentLength = textarea.value.length;
                counter.textContent = `${currentLength}/${maxLength} characters`;
                counter.style.color = currentLength > maxLength * 0.9 ? '#dc3545' : '#6c757d';
            }
        }
        
        if (skillsTextarea) {
            const skillsCounter = document.createElement('small');
            skillsCounter.className = 'char-counter float-end text-muted';
            skillsCounter.textContent = '0/500 characters';
            skillsTextarea.parentNode.insertBefore(skillsCounter, skillsTextarea.nextSibling);
            
            skillsTextarea.addEventListener('input', function() {
                updateCounter(this, 500);
            });
            updateCounter(skillsTextarea, 500);
        }
        
        if (experienceTextarea) {
            const experienceCounter = document.createElement('small');
            experienceCounter.className = 'char-counter float-end text-muted';
            experienceCounter.textContent = '0/2000 characters';
            experienceTextarea.parentNode.insertBefore(experienceCounter, experienceTextarea.nextSibling);
            
            experienceTextarea.addEventListener('input', function() {
                updateCounter(this, 2000);
            });
            updateCounter(experienceTextarea, 2000);
        }
    </script>
</body>
</html>